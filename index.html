<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt Coach</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(
          135deg,
          #4a148c 0%,
          #6a1b9a 50%,
          #8e24aa 100%
        );
        min-height: 100vh;
      }

      header {
        text-align: center;
        padding: 2rem 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        margin-bottom: 2rem;
      }

      h1 {
        color: white;
        font-size: 2.5rem;
        font-weight: 300;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      h2 {
        color: white;
        font-size: 1.5rem;
        font-weight: 400;
        margin: 1rem 0 0.5rem 0;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }

      main {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 2rem;
      }

      #fileInput {
        display: block;
        width: 100%;
        padding: 0.75rem;
        border: 2px dashed #ddd;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: border-color 0.3s ease;
      }

      #fileInput:hover {
        border-color: #667eea;
      }

      #textInput {
        width: 100%;
        padding: 1rem;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        transition: border-color 0.3s ease;
      }

      #textInput:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      button {
        display: block;
        width: 100%;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #00c853 0%, #00a047 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 200, 83, 0.3);
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 200, 83, 0.4);
        background: linear-gradient(135deg, #00d863 0%, #00b847 100%);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      button:disabled {
        background: #cccccc;
        color: #666666;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
        text-shadow: none;
        opacity: 0.6;
      }

      button:disabled:hover {
        transform: none;
        box-shadow: none;
        background: #cccccc;
      }

      pre {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        overflow-x: auto;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        color: #495057;
        white-space: pre-wrap;
      }

      #follow_up_questions_container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      #follow_up_questions_container h2 {
        margin: 0;
        margin-bottom: 0.5rem;
      }

      #follow_up_questions_list {
        color: white;
        font-size: 1rem;
        line-height: 1.6;
      }

      .question-item {
        color: white;
        margin-bottom: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        border-inline-start: 3px solid #00c853;
      }

      .question-text {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: white;
      }

      .answer-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-family: inherit;
        font-size: 1rem;
        transition: border-color 0.1s ease;
      }

      .answer-input:focus {
        outline: none;
        border-color: #00c853;
        box-shadow: 0 0 0 3px rgba(0, 200, 83, 0.1);
      }

      .answer-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      #chat_mode_container {
        margin-top: 1rem;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }

      .chat_mode_description {
        color: white;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .mode-buttons {
        display: flex;
        flex-direction: row;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: center;
      }

      .mode-btn {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: fit-content;
        opacity: 0.6;
        transition: opacity 0.3s ease;
        gap: 0.5rem;
      }

      .mode-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      #mobile_mode_btn {
        background: linear-gradient(135deg, #00c853 0%, #00a047 100%);
        box-shadow: 0 4px 15px rgba(0, 200, 83, 0.3);
      }

      #inspect_mode_btn {
        background: linear-gradient(135deg, #00c853 0%, #00a047 100%);
        box-shadow: 0 4px 15px rgba(0, 200, 83, 0.3);
      }

      #chat_mode_container {
        flex-direction: column;
        gap: 1rem;
      }

      .mode-label {
        display: inline-block;
      }

      #chat_mode_container[data-mode='mobile'] #mobile_mode_btn {
        opacity: 1;
      }

      #chat_mode_container[data-mode='inspect'] #inspect_mode_btn {
        opacity: 1;
      }

      #botSelect {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        transition: border-color 0.3s ease;
      }

      #botSelect:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      #customBotInput {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        transition: border-color 0.1s ease;
      }

      #customBotInput:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      @keyframes pulse {
        0% {
          transform: scale(1) rotate(0deg);
          box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
        }
        10% {
          transform: scale(1.05) rotate(-3deg);
          box-shadow: 0 0 0 4px rgba(255, 0, 0, 0.5);
        }
        20% {
          transform: scale(1.05) rotate(3deg);
          box-shadow: 0 0 0 6px rgba(255, 0, 0, 0.3);
        }
        30% {
          transform: scale(1.05) rotate(-2deg);
          box-shadow: 0 0 0 5px rgba(255, 0, 0, 0.4);
        }
        40% {
          transform: scale(1.05) rotate(2deg);
          box-shadow: 0 0 0 6px rgba(255, 0, 0, 0.3);
        }
        50% {
          transform: scale(1.05) rotate(-1deg);
          box-shadow: 0 0 0 5px rgba(255, 0, 0, 0.4);
        }
        60% {
          transform: scale(1.05) rotate(1deg);
          box-shadow: 0 0 0 6px rgba(255, 0, 0, 0.3);
        }
        70% {
          transform: scale(1.03) rotate(-0.5deg);
          box-shadow: 0 0 0 4px rgba(255, 0, 0, 0.4);
        }
        80% {
          transform: scale(1.02) rotate(0.5deg);
          box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.5);
        }
        90% {
          transform: scale(1.01) rotate(-0.2deg);
          box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.6);
        }
        100% {
          transform: scale(1) rotate(0deg);
          box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
        }
      }

      footer {
        text-align: center;
        padding: 2rem;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Prompt Coach</h1>
    </header>
    <main>
      <h2>Upload Files</h2>
      <input type="file" id="fileInput" multiple />

      <h2>Enter Text</h2>
      <textarea
        id="textInput"
        cols="30"
        rows="10"
        placeholder="Describe what you want to accomplish - the AI will ask questions to help refine your prompt."
        oninput="toggleSendMessageButtons()"
      ></textarea>

      <h2>Choose AI Bot</h2>
      <div id="botSelection">
        <select id="botSelect">
          <option value="@Assistant">@Assistant</option>
          <optgroup label="Lightweight Models (Fast & Cheap)">
            <option value="@GPT-5-nano">@GPT-5-nano</option>
            <option value="@GPT-4.1-nano">@GPT-4.1-nano</option>
            <option value="@Grok-3-Mini">@Grok-3-Mini</option>
            <option value="@DeepSeek-R1-Distill">@DeepSeek-R1-Distill</option>
          </optgroup>
          <optgroup label="Standard Models (Good Balance)">
            <option value="@GPT-5-mini">@GPT-5-mini</option>
            <option value="@GPT-4o-mini">@GPT-4o-mini</option>
            <option value="@Gemini-2.5-Flash-Lite">
              @Gemini-2.5-Flash-Lite
            </option>
            <option value="@DeepSeek-V3.1">@DeepSeek-V3.1</option>
            <option value="@Solar-Pro-2">@Solar-Pro-2</option>
          </optgroup>
          <optgroup label="Premium Models (Best Quality)">
            <option value="@GPT-5-Chat">@GPT-5-Chat</option>
            <option value="@Claude-Sonnet-4">@Claude-Sonnet-4</option>
            <option value="@Gemini-2.5-Pro">@Gemini-2.5-Pro</option>
            <option value="@Grok-4">@Grok-4</option>
          </optgroup>
          <optgroup label="Custom">
            <option value="custom">Custom Bot</option>
          </optgroup>
        </select>
        <input
          id="customBotInput"
          type="text"
          placeholder="Enter custom bot name (e.g., @MyBot)"
          hidden
        />
      </div>

      <div id="chat_mode_container" data-mode="mobile">
        <div class="chat_mode_description">
          <strong>Chat Mode:</strong> Toggle to open the full chat interface
          where you can study the raw prompts, learn how the tool works, and add
          your own custom instructions.
        </div>
        <div class="mode-buttons">
          <button
            id="mobile_mode_btn"
            onclick="chat_mode_container.dataset.mode = 'inspect'"
            class="mode-btn"
            title="Compact interface for quick prompt refinement"
          >
            <span class="mode-label">📱</span>
            <span class="mode-label">Mobile Mode</span>
          </button>
          <button
            id="inspect_mode_btn"
            onclick="chat_mode_container.dataset.mode = 'mobile'"
            class="mode-btn"
            title="Full chat interface to study raw prompts and learn how the tool works"
          >
            <span class="mode-label">🔍</span>
            <span class="mode-label">Inspect Mode</span>
          </button>
        </div>
      </div>

      <button
        id="submit_prompt_btn"
        onclick="submitAnswers({ allow_no_answer: true })"
        style="margin-top: 1rem; margin-bottom: 2rem"
      >
        Revise Prompt
      </button>

      <div id="follow_up_questions_container" hidden>
        <h2>Follow-Up Questions</h2>
        <div id="follow_up_questions_list"></div>
        <button
          id="submit_answers_btn"
          onclick="submitAnswers()"
          style="margin-top: 1rem; margin-bottom: 0"
        >
          Submit Answers & Revise Prompt
        </button>
      </div>

      <h2>Result</h2>
      <pre><code id="output">Awaiting input...</code></pre>
    </main>
    <footer>
      <p>
        A collaborative prompt refinement tool that leverages LLM AI to help you
        build better prompts together. Provide relevant documents or describe
        your needs, and the AI will ask targeted questions to help you craft
        clear, effective prompts.
      </p>
      <p>
        Built with Poe's embeddable integration for seamless AI-powered prompt
        development.
      </p>
    </footer>
    <script>
      let sample_prompt_result = {
        prompt:
          "Create a concise introduction to TypeScript for part-time DAE students in Hong Kong that covers its applications across frontend development, backend services, AI model training, and custom model integration. The content should be accessible to students who recently learned HTML, CSS, and JavaScript, focusing on high-level concepts rather than technical details. Structure the introduction to show TypeScript's versatility across the modern development stack, emphasize its value in Hong Kong's tech ecosystem, and conclude with a compelling call-to-action that motivates students to begin their TypeScript learning journey. Keep the tone encouraging and practical for working professionals balancing studies with career demands.",
        follow_up_questions: [
          'What format should this introduction take - written article, presentation slides, or video script?',
          'Should the AI model training section focus on specific frameworks like TensorFlow.js or PyTorch, or remain framework-agnostic?',
          'What specific call-to-action would be most appropriate - enrolling in a course, starting a project, or exploring documentation?',
          'Should the introduction mention specific Hong Kong companies or job opportunities that use TypeScript?',
          'How much emphasis should be placed on each domain (frontend/backend/AI) - equal weight or prioritized based on job market demand?',
          'Should the content address potential concerns about learning curve or time investment for part-time students?',
        ],
      }
      let has_sent_sample_prompt = false

      if (!window.Poe) {
        /* stub implementation for testing */

        window.Poe = {
          sendUserMessage: (message, options) => {},
          registerHandler: (handlerName, handler) => {},
          _stub_: true,
        }
      }

      window.Poe.registerHandler('resultHandler', (result, context) => {
        console.log({ receivedResult: result, context })
        output.textContent = JSON.stringify(result, null, 2)
        /**
         *
         * status: 'incomplete' | 'complete' | 'error
         * responses: Message[]
         *
         * // A message from the bot
         * type Message = {
         *   messageId: string;
         *   // The name of the bot that sent the message. e.g. "Assistant"
         *   senderId: string;
         *   // The entire content of the message recieved so far
         *   content: string;
         *   // Either text/plain or text/markdown
         *   contentType: string;
         *   // Each status should be handled to let the user know the current state of the message.
         *   status: "incomplete" | "complete" | "error";
         *   // A user friendly message to explain the current status.  Usually only specified for error status.
         *   statusText?: string;
         *   attachments?: MessageAttachment[];
         * };
         */
        let { status, responses } = result
        /* TODO: handle the status */
        if (responses.length == 1) {
          let message = responses[0]
          let {
            messageId,
            senderId,
            content,
            contentType,
            status,
            statusText,
            attachments,
          } = message
          /* Don't format below code to avoid give extra indentation */
          output.textContent = [
            `status: ${status}`,
            `contentType: ${contentType}`,
            `content: ${content}`,
            `attachments: ${JSON.stringify(attachments || [], null, 2)}`,
          ].join('\n')

          // try to parse the content in json
          try {
            let start_index = content.indexOf('{')
            if (start_index == -1) return
            let end_index = content.lastIndexOf('}')
            if (end_index == -1) return
            let json_text = content.slice(start_index, end_index + 1)
            let json_object = JSON.parse(json_text)
            console.log({ json_object })
            onPromptResult(json_object)
          } catch (error) {
            // invalid json format when the result is not completed?
            if (status !== 'incomplete') {
              // skip
              return
            }
            console.log({ error })
          }

          if (status === 'complete') {
            /* TODO: handle the complete message */
          }
        }
      })

      function onPromptResult(json_object) {
        let { prompt, follow_up_questions } = json_object

        // update the prompt
        textInput.value = prompt

        // display the follow_up_questions with input fields
        follow_up_questions_list.textContent = ''
        follow_up_questions.forEach((question, index) => {
          let questionDiv = document.createElement('div')
          questionDiv.className = 'question-item'

          let questionText = document.createElement('div')
          questionText.className = 'question-text'
          questionText.textContent = `${index + 1}. ${question}`

          let answerInput = document.createElement('input')
          answerInput.type = 'text'
          answerInput.className = 'answer-input'
          answerInput.placeholder = 'Enter your answer here...'
          answerInput.dataset.questionIndex = index
          answerInput.addEventListener('input', toggleSendMessageButtons)

          questionDiv.appendChild(questionText)
          questionDiv.appendChild(answerInput)
          follow_up_questions_list.appendChild(questionDiv)
        })

        // toggle visibility of follow_up_questions_container
        follow_up_questions_container.hidden = follow_up_questions.length === 0
        toggleSendMessageButtons()
      }

      function toggleSendMessageButtons() {
        let has_prompt = textInput.value.trim().length > 0

        submit_prompt_btn.disabled = !has_prompt
        submit_answers_btn.disabled = !has_prompt
      }

      // Add keyboard event listener for Ctrl+Enter
      document.addEventListener('keydown', event => {
        if (event.ctrlKey && event.key === 'Enter') {
          event.preventDefault()
          submitPrompt()
        }
      })

      // Handle bot selection
      function checkBotSelection() {
        if (botSelect.value === 'custom') {
          customBotInput.hidden = false
          customBotInput.focus()
        } else {
          customBotInput.hidden = true
          customBotInput.value = ''
        }
      }
      botSelect.addEventListener('change', checkBotSelection)
      checkBotSelection()

      // Initialize chat mode based on orientation
      chat_mode_container.dataset.mode = isPortrait() ? 'mobile' : 'inspect'

      function submitAnswers(options = {}) {
        let { allow_no_answer = false } = options
        let items = Array.from(
          follow_up_questions_list.querySelectorAll('.question-item'),
          item => {
            let question = item
              .querySelector('.question-text')
              .innerText.replace(/^\d+\.\s/, '')
            let answer = item.querySelector('.answer-input').value.trim()
            return {
              question,
              answer,
            }
          },
        )

        // Filter out items with empty answer
        items = items.filter(item => item.answer)

        // If no a single question is answered, remind the user
        if (
          !allow_no_answer &&
          items.length == 0 &&
          follow_up_questions_list.children.length > 0
        ) {
          // apply a pluse effect to the answer boxes
          let answers =
            follow_up_questions_list.querySelectorAll('.answer-input')
          for (let answer of answers) {
            answer.style.animation = 'pulse 1s'
            // Remove animation after it completes so it can be triggered again
            setTimeout(() => {
              answer.style.animation = ''
            }, 1000)
          }
          return
        }

        // Append Q&A pairs to the prompt
        if (items.length > 0) {
          let message = '\n\nContext from follow-up questions:'
          for (let item of items) {
            message += `\n\nQ: ${item.question}\nA: ${item.answer}`
          }
          textInput.value += message
        }

        // Hide the Q&A section to save space
        follow_up_questions_container.hidden = true

        // Send the updated message
        submitPrompt()
      }

      function isPortrait() {
        return window.innerHeight > window.innerWidth
      }

      async function submitPrompt() {
        // Get selected bot
        let botName = botSelect.value

        if (botName === 'custom') {
          botName = customBotInput.value.trim()
          if (!botName) {
            // Shake the custom bot input instead of showing alert
            customBotInput.style.animation = 'pulse 1s'
            setTimeout(() => {
              customBotInput.style.animation = ''
            }, 1000)
            customBotInput.focus()
            return
          }
        }
        if (!botName.startsWith('@')) {
          botName = `@${botName}`
        }

        /* Don't format below code to avoid give extra indentation */
        let message = [
          `${botName} revise the message:`,
          ``,
          textInput.value,
          ``,
          `Design a clear prompt. If you need to clarify on any context, ask in advance.`,
          ``,
          `Output in json format with`,
          `{`,
          `  prompt: string,`,
          `  follow_up_questions: string[],`,
          `}`,
          ``,
          `No need to include any other text in the output, it will be used as input for an interactive chat application.`,
        ]
        if (!has_sent_sample_prompt) {
          let last_line = message.pop()
          message.push(
            `Below is an example of output (for reference only):`,
            JSON.stringify(sample_prompt_result, null, 2),
            ``,
            last_line,
          )
          has_sent_sample_prompt = true
        }
        message = message.join('\n')
        let files = Array.from(fileInput.files)
        let openChat = chat_mode_container.dataset.mode === 'inspect'
        console.log({ message, files, openChat })
        let result = await window.Poe.sendUserMessage(message, {
          attachments: files,
          stream: true,
          openChat,
          handler: 'resultHandler',
        })
        console.log({ sendResult: result })

        // Check if the message was sent successfully
        if (result && result.success === true) {
          output.textContent = 'Waiting for response...'
        } else {
          output.textContent = JSON.stringify(result, null, 2)
        }
      }

      if (window.Poe._stub_) {
        onPromptResult(sample_prompt_result)
      }
    </script>
  </body>
</html>
